if Outcome == nil then
  Outcome = require "lib.Outcome"
end
if Vulnerability == nil then
  Vulnerability = require "lib.Vulnerability"
end
if Host == nil then
  Host = require "lib.Host"
end

local vuln_cve_2008_4250 = Vulnerability.lookup("CVE-2008-4250")

exploit_cve_2008_4250 = Outcome.new("exploit CVE-2008-4250")
exploit_cve_2008_4250.eval = function (target)
  local target_host = target.host
  local target_local_host = target.local_host

  local return_str = "[*] Started revers handler on " .. target.local_host_str .. ":4444\n[*] Automatically detecting the target...\n[*] Fingerprint: " .. target.host.os.name .. " " .. target.host.os.version .. "\n[*] Attempting to trigger the vulnerability...\n[*] Sending stage (240 bytes) to " .. target.host_str

  local flag_vulnerable = false
  for _,vuln in ipairs(target.host.os.vulnerabilities) do
    if vuln == vuln_cve_2008_4250 then
      flag_vulnerable = true
      break
    end
  end

  if target_local_host == nil or flag_vulnerable == false or (target_local_host.state ~= Host.State.Mine and target_local_host.state ~= Host.State.RootAccess) then
    return return_str
  end

  target_host:set_state(Host.State.RootAccess)
  return return_str .. "\n[*] Command shell session 1 opened"
end
