local top_panel_height = 40
local top_panel_y = 0
local control_panel_height = 300
local control_panel_y = love.graphics.getHeight() - control_panel_height
local map_panel_height = love.graphics.getHeight() - top_panel_height - control_panel_height
local map_panel_y = top_panel_height

local play = {}
play.elements = {}

play.dragging = {}
play.dragging.on = false
play.dragging.origin_x = 0
play.dragging.origin_y = 0
play.dragging.moved = false

function play:load()
  local top_panel = loveframes.Create("panel")
  top_panel:SetState("play")
  top_panel:SetPos(0, 0)
  top_panel:SetHeight(top_panel_height)
  top_panel:SetWidth(love.graphics.getWidth())
  self.top_panel = top_panel -- debug

  local menu_button = loveframes.Create("button")
  menu_button:SetParent(top_panel)
  menu_button:SetPos(0, 0)
  menu_button:SetText("Save & Exit") -- will be Menu later
  menu_button.OnClick = function(object)
    game:save_map()
    love.event.push('quit')
  end

  local top_score = loveframes.Create("text")
  top_score:SetParent(top_panel)
  top_score:SetText("Score: " .. tostring(game.score))
  top_score:SetPos(400, 0)
  top_score:SetFont(love.graphics.newFont(12))
  self.top_score = top_score

  local control_panel = loveframes.Create("panel")
  control_panel:SetState("play")
  control_panel:SetPos(0, control_panel_y)
  control_panel:SetHeight(control_panel_height)
  control_panel:SetWidth(love.graphics.getWidth())
  control_panel:MoveToTop()

  local ip_label = loveframes.Create("text", control_panel)
  ip_label:SetPos(20, 20)
  ip_label:SetText("Host: ")
  ip_label:SetFont(love.graphics.newFont(12))
  ip_label:SetVisible(false)
  play.elements.ip_label = ip_label

  local ip_text = loveframes.Create("text", control_panel)
  ip_text:SetPos(70, 20)
  ip_text:SetText("")
  ip_text:SetFont(love.graphics.newFont(12))
  ip_text:SetVisible(false)
  play.elements.ip_text = ip_text

  local tools_label = loveframes.Create("text", control_panel)
  tools_label:SetPos(20, 50)
  tools_label:SetText("Tools: ")
  tools_label:SetFont(love.graphics.newFont(12))
  tools_label:SetVisible(false)
  play.elements.tools_label = tools_label

  local tools_multichoice = loveframes.Create("multichoice", control_panel)
  tools_multichoice:SetPos(70, 45)
  tools_multichoice:SetVisible(false)
  play.elements.tools_multichoice = tools_multichoice

  local run_button = loveframes.Create("button", control_panel)
  run_button:SetPos(20, 250)
  run_button:SetText("Run")
  run_button:SetVisible(false)
  run_button:SetEnabled(false)
  play.elements.run_button = run_button
end

function play.update_map()
  for _,axis in ipairs({"x", "y"}) do
    for _,host in ipairs(map.hosts) do
      host.ui[axis] = host.ui["abs_" .. axis] - game.view_point[axis]
    end
    for _,network in ipairs(map.networks) do
      network.ui[axis] = network.ui["abs_" .. axis] - game.view_point[axis]
    end
  end
end

function play.update(dt)
  function scroll(axis, scroll_factor)
    game.view_point[axis] = game.view_point[axis] + scroll_factor * dt
  end

  if play.dragging.on then
    local mouse_x = love.mouse.getX()
    local mouse_y = love.mouse.getY()
    if play.dragging.moved == false then
      if play.dragging.origin_x ~= mouse_x or play.dragging.origin_y ~= mouse_y then
        play.dragging.moved = true
      end
    end
    game.view_point.x = game.view_point.x + play.dragging.origin_x - mouse_x
    game.view_point.y = game.view_point.y + play.dragging.origin_y - mouse_y
    play.dragging.origin_x = mouse_x
    play.dragging.origin_y = mouse_y
  else
    if love.mouse.getX() < WINDOW_PADDING then
      scroll("x", -SCROLL_SPEED)
    elseif love.mouse.getX() > love.window.getWidth() - WINDOW_PADDING then
      scroll("x", SCROLL_SPEED)
    end
    if love.mouse.getY() < WINDOW_PADDING then
      scroll("y", -SCROLL_SPEED)
    elseif love.mouse.getY() > love.window.getHeight() - WINDOW_PADDING then
      scroll("y", SCROLL_SPEED)
    end
  end
  play.update_map()
end

function play.draw()
  for _,network in ipairs(map.networks) do
    local flag_network_discovered = false
    for _,network_interface in ipairs(network.connected_network_interfaces) do
      if network_interface.host.state ~= Host.State.Undiscovered then
        love.graphics.line( network.ui.x+40, network.ui.y+3, network_interface.host.ui.x+network_interface.host.ui.width/2, network_interface.host.ui.y+network_interface.host.ui.height/2 )
      end
      if network_interface.host.state == Host.State.Mine or network_interface.host.state == Host.State.Compromised or network_interface.host.state == Host.State.RootAccess then
        flag_network_discovered = true
      end
    end
    if flag_network_discovered then
      love.graphics.print(network.CIDR, network.ui.x-20, network.ui.y-5)
    end
  end
end

function play.mousepressed(x, y, button)
  if button == "l" then
    play.dragging.on = true
    play.dragging.origin_x = x
    play.dragging.origin_y = y
  end
end

function play.mousereleased(x, y, button)
  if button == "l" and play.dragging.moved == false and game.selected_host then
    if y > top_panel_height and y < control_panel_y then
      game.selected_host.selected = false
      game.selected_host:set_image()
      game.selected_host = nil
      play.elements.ip_label:SetVisible(false)
      play.elements.ip_text:SetVisible(false)
      play.elements.tools_label:SetVisible(false)
      play.elements.run_button:SetVisible(false)
      play.elements.tools_multichoice:SetVisible(false)
      play.elements.tools_multichoice:Clear()
    end
  end
  play.dragging.on = false
  play.dragging.moved = false
end

return play