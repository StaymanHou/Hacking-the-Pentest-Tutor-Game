require "lib.util"
if Vulnerability == nil then
  Vulnerability = require "lib.Vulnerability"
end

local Service = {}
Service.__index = Service
Service.service_name_version_map = {}
Service.all = {}

function Service.new(name, version)
  local self = setmetatable({}, Service)
  self.name = name
  self.version = version
  self.vulnerabilities = {}
  Service.all[#(Service.all)+1] = self
  if Service.service_name_version_map[name] == nil then
    Service.service_name_version_map[name] = {}
  end
  Service.service_name_version_map[name][version] = self
  return self
end

function Service.load()
  local f = assert(io.open("data/services.dat", "r"))
  local t = f:read("*all")
  f:close()
  local items = t:split("======================================================\n")
  for index = 2, #items do
    local item = items[index]
    local lines = item:split("\n")
    local name = lines[1]:gsub("Name: ", "")
    table.remove(lines, 1)
    local version = lines[1]:gsub("Version: ", "")
    table.remove(lines, 1)
    local new_Service = Service.new(name, version)
    for line_index = 1, #lines do
      local vuln_id = lines[line_index]:gsub("Vulnerability: ", "")
      local vulnerability = Vulnerability.lookup(vuln_id)
      new_Service:add_vulnerability(vulnerability)
    end
  end
  return Service.all
end

function Service.lookup(name, version)
  return Service.service_name_version_map[name][version]
end

function Service:add_vulnerability(vulnerability)
  self.vulnerabilities[#(self.vulnerabilities)+1] = vulnerability
end

return Service